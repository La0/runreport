{% extends 'modal.html' %}
{% set modal_title = "Changer le role de "+member.first_name+" "+member.last_name %}

{% block body %}
<div class="roles">
	<form method="POST" action="{{ url('club-member-role', club.slug, member.username) }}">
		<p class="text-info">
      {{ member.first_name }} {{ member.last_name }} {{ _('is a %s in club') % _(membership.role|title()) }} : {{ club.name }}
      <br />
      {{ _('Member since') }}
      <span class="do-tooltip" title="{{ membership.created|date('l d E Y') }}">
        {{ membership.created|timesince() }}
      </span>
		</p>
    <p>
      <a href="{{ url('message-user-add', member.username ) }}" class="btn btn-sm btn-light btn-primary modal-action">
        <i class="icon-mail"></i>
        {{ _('Send a message') }}
      </a>
    </p>

		{% csrf_token %}

    {% if saved %}
    <p class="alert alert-success">
      {{ _('Your changes have been saved.') }}
    </p>
    {% endif %}

		<input class="role_value" type="hidden" name="role" value="{{membership.role}}"/>

		{% for role, role_name in roles.items() %}
    {% with diff, cost = bill.cost_new_role(membership.role, role) %}
    {% with available = not user.demo and (club.has_valid_card or cost == 0) %}
      <div class="panel panel-default">
        <div class="panel-heading">
          <p class="pull-right">
            {% if available %}
              {% if role == 'archive' %}

                {# Delete #}
                {% if membership.role == 'archive' %}
                {{ form.role }}
                <button type="submit" name="delete" value="true" class="role btn btn-danger btn-sm">
                  <i class="icon-trash"></i>
                  {{ _('Delete') }}
                </button>
                {% else %}

                {# Archive #}
                <button type="submit" name="role_local" value="archive" class="role btn btn-danger btn-sm">
                  {% if membership.role == 'prospect' %}
                    {{ _('Refuse this prospect') }}
                  {% else %}
                    {{ _('Archive this account') }}
                  {% endif %}
                </button>
                {% endif %}

              {% else %}
              {# Switch role #}
              <button type="submit" name="role_local" value="{{ role }}" class="role btn btn-sm btn-success">
                {{ _('Become') }} {{ role_name }}
              </button>
              {% endif %}

              
            {% else %}
            <a href="{{ url('payment-card', club.slug) }}" class="role btn btn-sm btn-success">
              {{ _('Add a credit card') }}
            </a>
            {% endif %}
          </p>
          <h5>
            {{ role_name }}
          </h5>
        </div>
        <div class="panel-body">


          <p>
          {% if cost == 0 %}
            <span class="label label-success">
              {{ _('Free') }}
            </span>
          {% else %}
            <span class="label label-warning">
              {{ _('Cost') }} {{ cost|floatformat(2) }} &euro;
            </span>
          {% endif %}
          </p>

          {% if membership.role == 'archive' %}
          <span class="text-danger">
            {{ _('This athlete is already archived, you can now delete it from your club.') }}
          </span>
          {% endif %}

          {% if cost == 0 %}
            {% if role == 'archive' %}
            <span class="text-danger">
              <i class="icon-help-circled"></i>
              {{ _('You can remove athletes from your club to lessen your costs.') }}
            </span>
            {% else %}
            <span class="text-success">
              <i class="icon-help-circled"></i>
              {{ _('This role is freely available to start your club.') }}
            </span>
            {% endif %}
          {% endif %}

          {% if not available %}
            <span class="text-warning">
              <i class="icon-help-circled"></i>
              {{ _('This role is not available until you have specified a credit card for your club.') }}
            </span>
          {% endif %}
        </div>
      </div>
    {% endwith %}
    {% endwith %}
		{% endfor %}

    <div class="form-group">
      <label class="control-label">
        {{ form.send_mail }}
        {{ _('Send an automatic email to the user when updating its role.') }}
      </label>
    </div>

		{% if membership.role in ('athlete', 'trainer') %}
		<hr />
		<div class="trainers">
			<h4>Choisir ses entraineurs</h4>
			{{form.trainers|safe}}
		</div>
		<button type="submit" class="btn btn-info pull-right" {% if user.demo %}disabled{% endif %}>{{ _('Save') }}</button>
		{% endif %}

	</form>
</div>
{% if user.demo %}
<div class="alert alert-warning" style="margin: 60px 0 0 0">
  <h4>{{ _('Demo account') }}</h4>
  {{ _('Edition is disabled for the demo.') }}
</div>
{% endif %}

<div class="clearfix">&nbsp;</div>
<div class="alert alert-danger modal-error" style="display: none">
  <h4>{{ _('Error') }}</h4>
  {{ _('An error occured while updating the athlete membership. Please retry after reloading the page.') }}
</div>

{% endblock %}
